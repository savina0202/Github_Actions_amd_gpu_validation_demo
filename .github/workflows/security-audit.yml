name: Security Audit (Reusable)

on:
  workflow_call:
  
permissions:
  actions: read
  contents: read
  security-events: write
  
jobs:
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install security tools
        run: |
          pip install bandit safety
      
      # - name: CodeQL Analysis (if configured)
      #   uses: github/codeql-action/analyze@v4
      #   with:
      #     languages: python
      #   continue-on-error: true
      
      # --- FIX: CodeQL requires init before analyze ---
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python
        continue-on-error: true

      - name: Analyze with CodeQL
        uses: github/codeql-action/analyze@v4
        continue-on-error: true
      # ------------------------------------------------      
      
      - name: Bandit security scan (full)
        run: |
          echo "Running full Bandit security scan..."
          bandit -r src/ -ll -f json -o bandit-audit-report.json || true
          bandit -r src/ -ll
        continue-on-error: true
      
      - name: Safety dependency audit (full)
        run: |
          echo "Running full Safety dependency audit..."
          safety check --json --output safety-audit-report.json || true
          safety check --full-report
        continue-on-error: true
      
      - name: Upload security audit reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-reports
          path: |
            bandit-audit-report.json
            safety-audit-report.json
          retention-days: 90

